# JSON剧本导入功能优化指南

## 🎯 优化内容

### 1. 增强的JSON解析
- ✅ 完整解析角色详细信息
- ✅ 处理HTML标签和特殊字符
- ✅ 智能提取剧本meta信息
- ✅ 支持additional字段处理

### 2. 智能分类系统
- ✅ 根据文件夹名称自动分类
- ✅ 根据剧本名称和描述智能分类
- ✅ 支持手动修改分类
- ✅ 13种预设分类

### 3. 改进的难度判断
- ✅ 从描述和additional信息中提取难度
- ✅ 支持"初学者"、"新手"、"高级"等关键词
- ✅ 自动识别"难度：初学者"等格式

### 4. 增强的数据验证
- ✅ 验证JSON格式正确性
- ✅ 检查必需字段完整性
- ✅ 验证角色信息有效性
- ✅ 详细的错误提示

### 5. 优化的用户界面
- ✅ 详细的导入结果显示
- ✅ 成功/失败统计
- ✅ 剧本名称和角色数量显示
- ✅ 分类筛选功能

## 📋 支持的JSON格式

### 标准格式
```json
[{
  "id": "_meta",
  "name": "剧本名称",
  "author": "作者",
  "description": "剧本描述",
  "logo": "logo图片URL",
  "townsfolkName": "镇民",
  "additional": [{
    "剧本介绍": "详细介绍...",
    "难度": "初学者"
  }]
}, {
  "id": "角色ID",
  "name": "角色名称",
  "ability": "角色能力描述",
  "team": "townsfolk|outsider|minion|demon|traveler",
  "firstNight": 夜晚顺序,
  "otherNight": 夜晚顺序,
  "firstNightReminder": "首夜提醒",
  "otherNightReminder": "其他夜晚提醒",
  "reminders": ["提醒标记"],
  "remindersGlobal": [],
  "setup": false,
  "image": "角色图片URL",
  "edition": "custom",
  "flavor": ""
}]
```

### 必需字段
- `_meta` 对象必须包含 `name` 字段
- 角色对象必须包含 `id`, `name`, `ability`, `team` 字段

## 🚀 使用方法

### 1. 界面导入

#### 单个剧本导入
1. 打开剧本管理界面 (`Alt + M` → 剧本管理)
2. 点击"导入剧本"按钮
3. 选择JSON文件
4. 系统会自动解析并导入剧本

#### 批量剧本导入
1. 打开剧本管理界面 (`Alt + M` → 剧本管理)
2. 点击"批量导入JSON"按钮
3. 选择分类（可选）
4. 选择JSON文件（支持多选）
5. 查看导入结果

### 2. 自动分类
系统会根据以下规则自动分类：
- **文件夹名称**: 根据文件夹名称映射分类
- **剧本名称**: 根据名称中的关键词分类
- **剧本描述**: 根据描述中的关键词分类

### 3. 分类映射
```
官方已发行剧本 → official (官方剧本)
经典混合剧本 → mixed (经典混合)
部分原创角色剧本 → custom (自制剧本)
全原创角色剧本 → custom (自制剧本)
节日&活动主题剧本 → event (节日活动)
脏镇7-9人中型剧本 → medium (中型剧本)
特别的玩法 → special (特别玩法)
海外相关剧本 → overseas (海外剧本)
汀西维尔剧本 → tingxi (汀西维尔)
快速上手相关 → beginner (快速上手)
体验剧本 → experience (体验剧本)
城市赛相关 → tournament (城市赛)
创作大赛相关 → competition (创作大赛)
世界杯相关 → worldcup (世界杯)
```

## 🔧 技术特性

### 1. 智能ID生成
- 移除特殊字符（#、空格、-、_）
- 保留中文和英文字符
- 添加时间戳确保唯一性
- 格式：`剧本名_时间戳`

### 2. 数据清理
- 自动清理HTML标签
- 处理`<br>`标签为换行符
- 移除多余空格和特殊字符
- 标准化文本格式

### 3. 错误处理
- 详细的错误信息
- 文件格式验证
- 数据完整性检查
- 角色信息验证

### 4. 导入统计
- 总文件数统计
- 成功/失败数量
- 按分类统计
- 角色数量统计

## 📊 导入结果示例

```
导入结果:
总计: 5 个文件
成功: 4 个
失败: 1 个

✓ test_script_1.json
  暗流涌动 (23 个角色)

✓ test_script_2.json
  险象环生 (18 个角色)

✗ test_script_3.json
  错误: 未找到剧本meta信息
```

## ⚠️ 注意事项

1. **文件格式**: 只支持UTF-8编码的JSON文件
2. **文件大小**: 建议单个文件不超过1MB
3. **角色ID**: 确保角色ID在系统中存在
4. **图片URL**: 确保图片URL可访问
5. **备份**: 导入前建议备份现有数据

## 🧪 测试功能

系统提供了完整的测试功能：

```javascript
import { runAllTests } from '@/utils/testImport';

// 运行所有测试
await runAllTests();
```

测试内容包括：
- JSON解析测试
- 分类功能测试
- 难度判断测试
- 导入流程测试

## 🔄 更新日志

### v2.0.0 (当前版本)
- ✅ 完整的JSON格式支持
- ✅ 智能分类系统
- ✅ 增强的数据验证
- ✅ 优化的用户界面
- ✅ 详细的错误处理
- ✅ 导入结果统计
- ✅ 测试功能
- ✅ **单个剧本导入修复** - 修复了单个剧本导入功能，现在可以正确解析JSON格式的剧本文件

### v1.0.0
- ✅ 基础导入功能
- ✅ 简单分类支持
- ✅ 基本错误处理 